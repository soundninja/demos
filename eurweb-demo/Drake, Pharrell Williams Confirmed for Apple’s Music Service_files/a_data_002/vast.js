"use strict";angular.module("com.zedo.videogular.plugins.vast",[]).directive("vgVastAds",["$timeout","$window","$document","VG_STATES","VG_EVENTS","xmlParserFactory","adOverlayFactory",function(a,b,c,d,e,f,g){return{restrict:"E",require:"^videogular",scope:{vgAdTagOnReady:"&",vgNetwork:"=",vgUnitPath:"=",vgCompanion:"=",vgCompanionSize:"=",vgAdTag:"=",vgAdTagIsInline:"=",vgPlayAdOnReady:"=",vgLandingPageOnClick:"=",vgOnclickFullscreen:"=",vgShowNonlinear:"=",vgSkipable:"=",vgOnAdSkip:"&",vgSkipimage:"=",vgSkipcount:"=",startAdFlag:"=vgStartAd",vgOnAdComplete:"&",vgOnCompanion:"&",vgOnNonlinearAd:"&",vgOnBeforePlay:"&",vgOnAdImpression:"&",vgOnAdTimeupdate:"&",vgOnBeforeComplete:"&",vgOnAdError:"&",vgOnAdClick:"&"},controller:["$scope","xmlParserFactory","$window",function(a,b,c){var e,f,h,i,j,k,l,m,n=!1,o=!1,p=!1,q=!1,r=a.vgAdTagOnReady(),s=a.vgOnAdComplete(),t=a.vgOnCompanion(),u=(a.vgOnNonlinearAd(),a.vgOnBeforePlay()),v=a.vgOnAdImpression(),w=a.vgOnAdTimeupdate(),x=a.vgOnBeforeComplete(),y=a.vgOnAdError(),z=a.vgOnAdClick(),A=a.vgOnAdSkip(),B=[],C={sources:[],currentTime:0},D=!1,E=!1,F=!1;a.vgFullscreenButtonClick=!1,a.loadTag=function(e){if(null===a.$parent.API){var h=document.getElementsByTagName("videogular"),i=angular.element(h).isolateScope();a.$parent.API=i.API}if(a.$parent.API.getState()===d.PLAY&&a.$parent.config.adMode&&(a.$parent.API.pause(),p=!0),m=a.vgAdTag,a.vgAdTagIsInline&&(m="XML Content Passed"),f=null,g.removeSkipButton(),e){var j=b.loadTagXml(a.vgAdTag);if(0==j.errorCode)var k=b.processXml(j.xmldoc,null,function(b){b=a.processResponse(b),0===b.errorCode?a.onReady():a.handleError(b)});else a.handleError(j)}else try{c.DMVAST.client.get(a.vgAdTag,function(b){b=a.processResponse(b),0===b.errorCode?a.onReady():a.handleError(b)})}catch(l){var k={};k.errorCode=100,k.errorMessage="Unable to load the vast tag",a.handleError(k)}},a.handleError=function(b){var d={};d.adId=f&&!angular.isUndefined(f)?f.ad.id:b.adId,y&&y(m,b.errorMessage,d),f&&!angular.isUndefined(f)&&1!=b.errorCode&&c.DMVAST.util.track(f.ad.errorURLTemplates,{ERRORCODE:b.errorCode}),e=null,f=null,h=null,a.loadSnapShot(!1),g.removeSkipButton(),p&&a.$parent.API.play()},a.getSnapShot=function(){(null==e||angular.isUndefined(e))&&(C.sources=a.$parent.config.sources,null!==a.$parent.API&&(C.currentTime=a.$parent.API.getCurrentTime()))},a.loadSnapShot=function(b){!angular.isUndefined(C.sources)&&C.sources.length>0?a.$parent.safeApply(function(){a.$parent.config.adMode=!1,a.$parent.config.sources=C.sources}):b&&a.$parent.API&&(a.$parent.API.videoElement.removeAttr("src"),a.$parent.API.videoElement.removeAttr("type"),a.$parent.API.loadVideo())},a.onReady=function(){if(!angular.isUndefined(f)&&null!=f){var b=a.getCurrentSource(j);if(angular.isDefined(b)&&!angular.isUndefined(b)){var c={};c.adId=f.ad.id,c.mediaWidth=b.width,c.mediaHeight=b.height,c.adType=b.adType,c.clickThrough=f.clickThroughURLTemplate,c.mediaURL=b.src,r&&r(b.src,f.clickThroughURLTemplate,c.adType,c),n&&a.vgPlayAdOnReady&&a.startAd()}else{var d={};d.errorCode=403,d.errorMessage="No compatible creative found",a.handleError(d)}}},a.startAd=function(){var b;a.$parent.config.plugins.ads.startAd=!1,angular.isUndefined(f)||null==f||(a.$parent.config.media&&a.getSnapShot(),e=f,a.$parent.safeApply(function(){a.$parent.config.media=!1,a.$parent.config.adMode=!0,a.$parent.config.sources=j}),o=!1,q=!1,null!=a.$parent.API&&(b=a.$parent.API.getSize()),g.clickThroughOverlay(f,b,a),e.skipDelay&&a.vgSkipable?g.skipButton(a):g.removeSkipButton(),a.$parent.API.play())},a.skipAd=function(b){e&&e.skipable&&(g.removeSkipButton(),e&&e.skip(),A&&A(m),e=null,h=null,i=null,g.removeNonLinearAd(a),(angular.isUndefined(C.sources)||C.sources.length<=0)&&a.$parent.API.isFullScreen()&&a.$parent.API.toggleFullScreen(b),a.loadSnapShot(!0))},a.clearAd=function(){e=null,f=null,h=null,B=[],a.loadSnapShot(!0)},a.onAdProgress=function(){angular.isUndefined(e)||null==e||o||(v&&v(m,e.ad.impressionURLTemplates),t&&!angular.isUndefined(f.companions)&&f.companions.length>0&&t(m,f.companions),o=!0)},a.showNonlinearAd=function(b){var c=a.$parent.API.getSize().width,d=a.$parent.API.getSize().height;if(h=g.getNonLinearTracker(b,c,d),h&&!angular.isUndefined(h)){var e=g.getCreativeElement(h);return h.creative.minSuggestedDuration,g.showNonlinearAd(e,a)}},a.onAdClick=function(b){if(!angular.isUndefined(e)&&null!=e){var f=a.$parent.API.getState(),g=angular.element(c)[0].fullScreenAPI;if(f===d.PLAY||q){q?(q=!q,e.track("rewind"),e.replay=!0,a.vgLandingPageOnClick&&k&&(a.$parent.API.isiOSDevice()?a.$parent.API.replay():(a.$parent.API.replay(),D=!0,c.open(k,"_blank")))):g&&a.vgOnclickFullscreen&&!a.$parent.API.isiOSDevice()&&!a.$parent.API.isAndroid()||g&&a.vgFullscreenButtonClick&&!a.$parent.API.isiOSDevice()?a.$parent.API.isFullScreen()?(D=!0,c.open(k,"_blank")):a.$parent.API.toggleFullScreen(b):a.vgLandingPageOnClick&&k&&!a.$parent.API.isiOSDevice()&&(D=!0,c.open(k,"_blank")),a.$parent.API.isiOSDevice()&&(g&&a.vgOnclickFullscreen&&!a.$parent.API.isFullScreen()||g&&a.vgFullscreenButtonClick&&!a.$parent.API.isFullScreen()?a.$parent.API.toggleFullScreen(b):(a.$parent.API.isFullScreen()&&(D=!0,a.$parent.API.toggleFullScreen(b)),window.parent.zziOSAdClick(b,a.$parent.playerId))),z&&z(m,k);var h=e.clickTrackingURLTemplate;h&&e.click()}else a.$parent.API.play(),a.$parent.API.isiOSDevice()||a.$parent.API.toggleFullScreen();return!1}},a.processResponse=function(d){if(d&&0===d.errorCode)for(var e=0;e<d.ads.length;e++){for(var g=d.ads[e],h=0;h<g.creatives.length;h++){var i=g.creatives[h];if("linear"!==i.type||!angular.isUndefined(f)&&null!==f)if("companion"===i.type){for(var l=0,m=i.variations.length;m>l;l++)(null===i.variations[l].id||angular.isUndefined(i.variations[l].id))&&(i.variations[l].id=l);f.companions.push(i)}else"nonlinear"===i.type&&(null===f&&(f=new c.DMVAST.tracker(g,i)),B.push(i));else if(i.mediaFiles.length){if(f=new c.DMVAST.tracker(g,i),j=b.createSourceObjects(i.mediaFiles,a.$parent.API.getBandWidth()),!j.length)return d.errorCode=403,d.errorMessage="No creative was found to play the ad",d;k=f.clickThroughURLTemplate?f.clickThroughURLTemplate:null}else d.errorCode=403,d.errorMessage="No creative was found to play the ad"}if((angular.isUndefined(f)||null==f)&&g.errorURLTemplates)return c.DMVAST.util.track(g.errorURLTemplates,{ERRORCODE:401}),d.errorCode=1,d.errorMessage="No Creative was found.",d}return d},a.onPlayTracker=function(){q&&e&&(e.track("rewind"),e.replay=!0),q=!1,e&&e.setPaused(!1)},a.onPauseTracker=function(){e&&e.setPaused(!0)},a.onMuteTracker=function(a,b){e&&e.setMuted(b[0])},a.getCurrentSource=function(a){var b="";if(!angular.isUndefined(a))for(var c=document.createElement("video"),d=0,e=a.length;e>d;d++)if(b=c.canPlayType(a[d].type),"maybe"===b||"probably"===b)return a[d];return b},a.onTimeTracker=function(b,c){e&&!angular.isUndefined(e)&&(isNaN(e.assetDuration)&&(e.assetDuration=c[1]),w&&!isNaN(c[1])&&w(m,c[0].toString(),c[1].toString()),a.$parent.isStopped?(e.progress=0,a.$parent.isStopped=!1):(e.setProgress(c[0]),g.enableSkip(c[0],e))),(null===e||angular.isUndefined(e))&&(c[0]!==l||F||x&&(x(),F=!0))},a.loadTracker=function(){e&&!angular.isUndefined(e)&&a.$parent.config.adMode&&e.load()},a.onVideoComplete=function(){e&&!angular.isUndefined(e)&&(q||e.complete(),s&&s(m),a.$parent.API.isFullScreen()&&(E=!0,a.$parent.API.toggleFullScreen()),q=!0,a.loadSnapShot(!1),g.removeSkipButton(),i=null,g.removeNonLinearAd(a))},a.onFullScreenTracker=function(b){e&&(e.setFullscreen(b),b||((a.vgLandingPageOnClick&&a.vgOnclickFullscreen&&k&&!D&&!E||a.vgFullscreenButtonClick&&!D&&!E&&!a.$parent.API.isiOSDevice())&&c.open(k,"_parent"),a.vgFullscreenButtonClick&&(a.vgFullscreenButtonClick=!1),E=!1),D=!1)},a.onPlayerInit=function(){n=!0,a.vgPlayAdOnReady&&a.startAd()},a.onSourceChange=function(){e&&!angular.isUndefined(e)&&a.$parent.config.adMode?a.$parent.API.loadVideo():(e=null,f=null,h=null,g.removeClickThorugh())},a.onResize=function(b,c){e&&!angular.isUndefined(e)&&a.$parent.config.adMode&&g.resizeBlocker(c[1]),a.vgShowNonlinear&&i&&h&&g.alignNonlinearAd(i,c[0],c[1],h.creative.width,h.creative.height)},a.onAdError=function(b){var c;if(a.$parent.config.adMode&&b.target.error){var d="Error playing media";switch(b.target.error.code){case b.target.error.MEDIA_ERR_ABORTED:d="Aborted the video playback.",c=400;break;case b.target.error.MEDIA_ERR_NETWORK:d="A network error caused the video download to fail part-way.",c=402;break;case b.target.error.MEDIA_ERR_DECODE:d="The video playback was aborted due to a corruption problem or because the video used features your browser did not support.",c=405;break;case b.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:d="The video could not be loaded, either because the server or network failed or because the format is not supported.",c=405;break;default:d="General Linear error. Video player is unable to display the Linear Ad",c=400}g.removeClickThorugh();var e={};e.errorCode=c,e.errorMessage=d,a.handleError(e)}},a.onLoadedMetaData=function(b){var c=a.$parent.isStopped;null===e||angular.isUndefined(e)&&!c?(u&&u(),a.$parent.config.adMode&&(a.$parent.API.pause(),p=!0),l=b.target.duration,F=!1,C.currentTime&&!angular.isUndefined(C.currentTime)&&a.$parent.API.seekTime(C.currentTime),c&&(a.$parent.isStopped=!1),B&&B.length>0&&a.vgShowNonlinear&&(i=a.showNonlinearAd(B))):e.setAssetDuration(b.target.duration)},a.$watch("startAdFlag",function(b){b&&a.startAd()})}],link:function(a,b,c,d){a.$watch("vgAdTag",function(b,c){angular.isUndefined(b)||""==b||b==c?a.clearAd():(a.clearAd(),a.loadTag(a.vgAdTagIsInline))}),d.$on(e.ON_COMPLETE,a.onVideoComplete),d.$on(e.ON_MUTE,a.onMuteTracker),d.$on(e.ON_START_PLAYING,a.onPlayTracker),d.$on(e.ON_PAUSE,a.onPauseTracker),d.$on(e.ON_UPDATE_TIME,a.onTimeTracker),d.$on(e.ON_PLAYER_INIT,a.onPlayerInit),d.$on(e.ON_SOURCE_CHANGE,a.onSourceChange),d.$on(e.ON_UPDATE_SIZE,a.onResize),d.$on(e.ON_ENTER_FULLSCREEN,function(){a.onFullScreenTracker(!0)}),d.$on(e.ON_EXIT_FULLSCREEN,function(){a.onFullScreenTracker(!1)}),d.videoElement.bind("canplay",a.loadTracker),d.videoElement.bind("loadedmetadata",a.onLoadedMetaData),d.videoElement.bind("error",a.onAdError),d.videoElement.bind("play",a.onAdProgress),d.isIE10()&&d.videoElement.bind("click",a.onAdClick),angular.isUndefined(a.vgAdTag)||a.loadTag(a.vgAdTagIsInline)}}}]).factory("xmlParserFactory",["$window","$http","$sce",function(a){function b(a,b){return a.protocol==b}function c(c,d){var e=[],f=[],g=[],h=!1,i=a.location.protocol;"https:"==i&&(h=!0);var j=document.createElement("a"),k=["video/mp4","video/webm","video/ogv"];c.sort(function(a,b){return a.bitrate>b.bitrate});for(var l=0;l<c.length;l++){var m=c[l].fileURL,n=c[l].mimeType;if(j.href=m,k.indexOf(n)>=0){if(h&&!b(j,i))continue;e.push(c[l]),(0==d||d>c[l].bitrate)&&f.push(c[l])}}f.length>0&&(e=f,e.sort(function(a,b){return a.bitrate<b.bitrate}));for(var o=0;o<e.length;o++)void 0!==e[o]&&g.push({type:e[o].mimeType,src:e[o].fileURL,adType:e[o].apiFramework,width:e[o].width,height:e[o].height});return g}return{loadTagXml:function(a){var b,c=0,d="";if(window.DOMParser){var e=new DOMParser;try{b=e.parseFromString(a,"text/xml")}catch(f){return c=100,d="XML parsing error.",{errorCode:c,errorMessage:d}}}else{if("undefined"==typeof ActiveXObject)return c=100,d="Cannot create XMLDocument object",{errorCode:c,errorMessage:d};ids=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument"];for(var g=0,h=ids.length;h>g;++g)try{b=new ActiveXObject(ids[g]);break}catch(f){}if(!b)return c=100,d="Cannot create XMLDocument object",{errorCode:c,errorMessage:d};if(b.loadXML(a),b.parseError&&0!=b.parseError.errorCode)return c=100,d="XML Parsing Error: "+b.parseError.reason+" at line "+b.parseError.line+" at position "+b.parseError.linepos,{errorCode:c,errorMessage:d};if(!b.documentElement)return c=100,d="XML Parsing Error!",{errorCode:c,errorMessage:d};if("parsererror"==b.documentElement.nodeName)return c=100,d=b.documentElement.childNodes[0].nodeValue,{errorCode:c,errorMessage:d}}return{xmldoc:b,errorCode:c,errorMessage:d}},processXml:function(b,c,d){a.DMVAST.parser.parseXml(b,c,d)},createSourceObjects:c}}]).factory("adOverlayFactory",["$window","$compile","$rootScope","$timeout",function(a,b,c){function d(b,c){var d,e,f;switch(b.creativeType){case"application/x-javascript":return f=document.createElement("script"),f.setAttribute("src",b.resource),f;case"application/x-shockwave-flash":return e=document.createElement("object"),e.setAttribute("data",b.resource),e.setAttribute("width",b.width),e.setAttribute("height",b.height),e;case"image/gif":case"image/jpeg":case"image/png":return d=new Image,d.src=b.resource,d.width=b.width,d.height=b.height,b.clickThroughURLTemplate&&(d.onclick=function(){a.open(b.clickThroughURLTemplate,"_blank"),c.clickTrackingURLTemplate&&c.trackURLs(c.clickTrackingURLTemplate),b.trackingEvents.click&&c.trackURLs(b.trackingEvents.click)}),d}}function e(a){var b=document.createElement("iframe");return b.src=a.resource,b.setAttribute("allowfullscreen",!0),b.setAttribute("seamless",!0),b.setAttribute("frameborder",0),b.setAttribute("scrolling","no"),b.width=a.width,b.height=a.height,b}function f(a){var d=angular.element(a.resource),e=c.$new();return b(d)(e),d.width=a.width,d.height=a.height,d}return{clickThroughOverlay:function(d,e,f){this.removeClickThorugh();var g=angular.element(document.createElement("div")),h=c.$new();if(b(g)(h),g.addClass("vast-blocker"),!angular.isUndefined(e)){var i=e.height-30;g.css("height",i+"px")}g.bind("click",f.onAdClick),a.DMVAST.blocker=g,angular.element(document.getElementById("mainContainer")).prepend(g)},removeClickThorugh:function(){angular.isUndefined(a.DMVAST.blocker)||(a.DMVAST.blocker.remove(),delete a.DMVAST.blocker)},resizeBlocker:function(b){if(!angular.isUndefined(a.DMVAST.blocker)){var c=b-30;a.DMVAST.blocker.css("height",c+"px")}},skipButton:function(d){this.removeSkipButton();var e=angular.element(document.createElement("div")),f=angular.element(document.createElement("div")),g=angular.element(document.createElement("img")),h=c.$new();b(e)(h),b(f)(h),b(g)(h),g.attr("src",d.vgSkipimage),f.addClass("videoAdUiSkipText"),e.addClass("vast-skip-button"),g.css("width","100px"),g.css("height","35px"),d.vgSkipcount?(e.addClass("enabled"),e.append(f)):e.append(g),e.bind("click",d.skipAd),a.DMVAST.skipButton=e,a.DMVAST.skipButtonText=f,angular.element(document.getElementById("mainContainer")).append(e)},removeSkipButton:function(){angular.isUndefined(a.DMVAST.skipButton)||(a.DMVAST.skipButton.remove(),delete a.DMVAST.skipButton)},enableSkip:function(b,c){if(!angular.isUndefined(a.DMVAST.skipButton)){var d=Math.ceil(c.skipDelay-b);d>=0?(a.DMVAST.skipButtonText.html(""),a.DMVAST.skipButtonText.html("Skip Ad in "+d+"...")):(a.DMVAST.skipButton.hasClass("enabled")||a.DMVAST.skipButton.addClass("enabled"),a.DMVAST.skipButtonText.html(""),a.DMVAST.skipButtonText.html("Skip Ad"))}},showNonlinearAd:function(a,b){var c,d,e;if(b.$parent.deleteButton("nonLinear"),c=b.$parent.API.getSize().height,d=b.$parent.API.getSize().width,a&&!angular.isUndefined(a)){var f=c-a.height-30,g=(d-a.width)/2,h={};return h.id="nonLinear",h.width=a.width,h.height=a.height,h.top=f,h.left=g,h.template='<div style="right:0;top:0;position:absolute"><div class="close-padding"><div class="close-button" ng-click="turnMeOff()"></div> </div></div>',a.onerror=function(){b.$parent.deleteButton("nonLinear")},e=b.$parent.addButton(h),e.append(a),e.scope().turnMeOff=function(){b.$parent.deleteButton("nonLinear")},e}},getNonLinearTracker:function(b,c,d){for(var e=0;e<b.length;e++)for(var f=b[e],g=0;g<f.variations.length;g++){var h=f.variations[g];if(h.height<d&&h.width<c){var i=new a.DMVAST.tracker(f,h);return i.clickTrackingURLTemplate=[h.clickTrackingURLTemplate],i}}},getCreativeElement:function(a){var b=a.creative;switch(b.resourceType){case"static":return d(b,a);case"iframe":return e(b);case"html":return f(b)}},removeNonLinearAd:function(a){a.$parent.deleteButton("nonLinear")},alignNonlinearAd:function(a,b,c,d,e){if(a&&!angular.isUndefined(a)){var f=c-e-30+"px",g=(b-d)/2+"px";a.css("top",f),a.css("left",g)}}}}]);