(function(){var SubscribeWidget,connect_facebook_path,signup_path,subscriber_count_site_path,subscriber_count_user_path,user_subscription_path,user_subscriptions_path,whoami_users_path;signup_path=function(verb){return"/join"+verb};subscriber_count_user_path=function(id,format,verb){return"/users/"+id+"/subscriber_count"+format+""};subscriber_count_site_path=function(id,format,verb){return"/sites/"+id+"/subscriber_count"+format+""};user_subscription_path=function(user_id,id,format,verb){return"/users/"+user_id+"/subscriptions/"+id+""+format+""};user_subscriptions_path=function(user_id,format,verb){return"/users/"+user_id+"/subscriptions"+format+""};whoami_users_path=function(format,verb){return"/users/whoami"+format+""};connect_facebook_path=function(format,verb){return"/facebook/connect"+format+""};window.nop=function(e){e.preventDefault();return true};window.SHUFFLER={join:{afterLogin:function(type,options){var _this=this;if(type==="Fb"){return $.ajax({type:"POST",url:connect_facebook_path(".json"),data:null,dataType:"json",success:function(data){if(data.status==="success"){return $.get(subscribeWidget.web_url+whoami_users_path(".json"),function(response){subscribeWidget.user_id=response.id;return subscribeWidget.handleSubscribable("subscribe")})}}})}else{return $.get(subscribeWidget.web_url+whoami_users_path(".json"),function(response){subscribeWidget.user_id=response.id;return subscribeWidget.handleSubscribable("subscribe")})}}}};SubscribeWidget=function(){function SubscribeWidget(){this.initParams();this.checkLoggedInStatus();this.checkCounter();this.initEvents()}SubscribeWidget.prototype.initParams=function(){var asset_urls,gaqDomain,params,url,web_urls;params=this.parseUrlParams();this.subscribable_type=params["subscribable_type"]||"Site";this.subscribable_id=params["subscribable_id"]||params["site_id"];this.counter=params["counter"]==="1";this.environment=params["environment"]||"production";web_urls={development:"http://localhost:3000",preproduction:"https://pre.shuffler.fm",production:"https://shuffler.fm"};this.web_url=web_urls[params["environment"]||"production"];asset_urls={development:"http://s3.amazonaws.com/development-shuffler",preproduction:"https://d9lo87zaly9wg.cloudfront.net",production:"https://d1v2xm8p2pd3wl.cloudfront.net"};this.asset_url=asset_urls[params["environment"]||"production"]+"/assets/static";if(this.environment==="production"){url="/subscribe_widget/"+this.subscribable_type.toLowerCase()+"/"+this.subscribable_id;gaqDomain="shuffler.fm"}else{url="/subscribe_widget/"+this.subscribable_type.toLowerCase()+"/"+this.subscribable_id+"?not_production=";gaqDomain="none"}if(typeof _gaq!=="undefined"&&_gaq!==null){_gaq.push(["_setDomainName",gaqDomain])}if(typeof _gaq!=="undefined"&&_gaq!==null){_gaq.push(["_trackPageview",url])}return $("#shuffler-subscribe-button").addClass(params["face"]+" "+params["theme"])};SubscribeWidget.prototype.checkLoggedInStatus=function(){var _this=this;if(document.cookie.indexOf("user_credentials=")===-1){return this.updateActionButton("join")}else{return $.ajax({url:this.web_url+user_subscription_path("_",this.subscribable_id,".json?subscribable_type="+this.subscribable_type),type:"GET",dataType:"json",success:function(data){_this.user_id=data[0].user_id;return _this.updateActionButton("unsubscribe")},statusCode:{404:function(){return _this.updateActionButton("subscribe")}}})}};SubscribeWidget.prototype.checkCounter=function(){var count_url,counterEl,_this=this;if(this.counter){counterEl=$("#counter");counterEl.removeClass("nocount");count_url=subscriber_count_site_path(this.subscribable_id,".json");if(this.subscribable_type==="User"){count_url=subscriber_count_user_path(this.subscribable_id,".json")}return $.ajax({url:this.web_url+count_url,type:"GET",dataType:"json",success:function(data){return counterEl.html(data.data)}})}};SubscribeWidget.prototype.parseUrlParams=function(){var hash,hashes,queryString,vars,_i,_len;vars={};queryString=window.location.href.slice(window.location.href.indexOf("?")+1);if(queryString.indexOf("#")>-1){queryString=queryString.slice(0,queryString.indexOf("#"))}hashes=queryString.split("&");for(_i=0,_len=hashes.length;_i<_len;_i++){hash=hashes[_i];hash=hash.split("=");vars[hash[0]]=hash[1]}return vars};SubscribeWidget.prototype.popup=function(url,title,width,height){var left,newwin,params,top;if(title==null){title="Shuffler.fm"}if(width==null){width=640}if(height==null){height=560}left=(screen.width-width)/2;top=(screen.height-height)/2;params="width="+width+", height="+height;params+=", top="+top+", left="+left;params+=", directories=no";params+=", location=no";params+=", menubar=no";params+=", resizable=no";params+=", scrollbars=no";params+=", status=no";params+=", toolbar=no";newwin=window.open(url,title,params);if(window.focus){newwin.focus()}return newwin};SubscribeWidget.prototype.openJoin=function(flash){if(flash!=null?flash.length:void 0){this.joinWindow=this.popup(this.web_url+signup_path("?message="+flash),"shufflerfm_join")}else{this.joinWindow=this.popup(this.web_url+signup_path(""),"shufflerfm_join")}this.joinWindow.focus();if(!this.joinWindow.opener){return this.joinWindow.opener=window}};SubscribeWidget.prototype.handleSubscribable=function(state){var user_id,_this=this;user_id=this.user_id!=null?this.user_id:"_";return $.ajax({url:state==="subscribe"?this.web_url+user_subscriptions_path(user_id,".json"):this.web_url+user_subscription_path(user_id,this.subscribable_id,".json?subscribable_type="+this.subscribable_type),type:"POST",data:{_method:state==="subscribe"?"post":"delete",dataType:"json",authenticity_token:this.authenticity_token,subscribable_type:this.subscribable_type,subscribable_id:this.subscribable_id,from_widget:true},success:function(data){if(state==="subscribe"){_this.updateActionButton("unsubscribe");$("#counter").text(parseInt($("#counter").text())+1)}else{_this.updateActionButton("subscribe");$("#counter").text(parseInt($("#counter").text())-1)}return _this.sendGaqEvent(state)}})};SubscribeWidget.prototype.sendGaqEvent=function(e){if(typeof _gaq!=="undefined"){return _gaq.push(["_trackEvent","subscribeWidget",e,""+this.subscribable_type.toLowerCase()+":"+this.subscribable_id])}};SubscribeWidget.prototype.initEvents=function(){var _this=this;return $(document).on("click","#action-button.subscribe",function(e){nop(e);return _this.handleSubscribable("subscribe")}).on("click","#action-button.unsubscribe",function(e){nop(e);return _this.handleSubscribable("unsubscribe")}).on("click","#action-button.join",function(e){nop(e);return _this.openJoin("Join Shuffler.fm and stay up to date with this Site!")})};SubscribeWidget.prototype.updateActionButton=function(state){return $("#action-button").removeClass().addClass(state)};return SubscribeWidget}();$(function(){return window.subscribeWidget=new SubscribeWidget})}).call(this);